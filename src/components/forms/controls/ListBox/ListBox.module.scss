/* Copyright (c) Fortanix, Inc.
|* This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of
|* the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/. */

@use '../../../../styling/defs.scss' as bk;

@layer baklava.components {
  .bk-list-box {
    @include bk.component-base(bk-list-box);
    
    --bk-list-box-padding-end: #{bk.$spacing-2}; // Extra padding included at the end of the list
    --bk-list-box-item-padding-inline: #{bk.$spacing-4};
    --bk-list-box-item-padding-block: #{bk.$spacing-2};
    --bk-list-box-item-block-size: calc(#{bk.rem-from-px(1)} + var(--bk-list-box-item-padding-block) * 2 + 1lh);
    
    overflow: hidden;
    scroll-behavior: smooth;
    scroll-padding-block:
      var(--bk-list-box-item-block-size)
      calc(var(--bk-list-box-item-block-size) + var(--bk-list-box-padding-end));
    
    min-inline-size: 30ch;
    max-block-size: 12lh;
    padding-block-end: var(--bk-list-box-padding-end);
    
    background: bk.$theme-dropdown-menu-menu-background-default;
    border: bk.rem-from-px(1) solid bk.$theme-dropdown-menu-menu-border-default;
    
    border-radius: bk.$radius-2;
    &[data-placement^="bottom"] {
      border-start-start-radius: 0;
      border-start-end-radius: 0;
    }
    &[data-placement^="top"] {
      border-end-start-radius: 0;
      border-end-end-radius: 0;
    }
    
    display: flex;
    flex-direction: column;
    align-items: stretch;
    
    // Note: currently works up to two levels deep, in the future could use `@scope () to (.bk-list-box)` for this
    &:not(:has(> :nth-child(1 of .bk-list-box__item), > :not(.bk-list-box) > :nth-child(1 of .bk-list-box__item))) {
      &::before {
        content: attr(data-empty-placeholder, 'No items');
        padding: bk.$spacing-2 bk.$spacing-4;
        display: flex;
        color: bk.$theme-text-small-text-subtle;
      }
    }
    
    .bk-list-box__item {
      // https://github.com/TanStack/virtual/issues/860
      contain: paint;
      will-change: transform;
      
      // FIXME: enabling this causes a strange issue with keyboard navigation (scrolling goes too far down/up)
      //content-visibility: auto;
      // Border + padding + content
      //contain-intrinsic-block-size: calc(bk.rem-from-px(1) + var(--bk-list-box-item-padding-block) * 2 + 1lh);
      
      padding: var(--bk-list-box-item-padding-block) var(--bk-list-box-item-padding-inline);
      background: bk.$theme-dropdown-menu-menu-background-default;
      
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: bk.$sizing-2;
      
      @include bk.font(bk.$font-family-body);
      font-size: bk.$font-size-m;
      
      > .bk-list-box__item__label {
        @include bk.text-one-line($include-padding: false);
      }
      
      border-block-start: bk.rem-from-px(1) solid transparent; // Keep a transparent border for consistent height
      &:not(:first-child) {
        border-block-start-color: bk.$theme-dropdown-menu-menu-border-default;
      }
      
      &:not(.bk-list-box__item--static) {
        &:not(:disabled, .bk-list-box__item--disabled):hover {
          background: bk.$theme-dropdown-menu-menu-background-hover;
        }
        &[aria-selected="true"] {
          background: bk.$theme-dropdown-menu-menu-background-hover;
          // stylelint-disable-next-line declaration-no-important -- Override accessibility layer
          box-shadow: inset 5px 0 bk.$theme-dropdown-menu-menu-tab-default !important;
        }
        
        @media (prefers-reduced-motion: no-preference) {
          transition: box-shadow 150ms ease-in;
        }
      }
      &:is(:disabled, .bk-list-box__item--disabled) {
        color: bk.$theme-text-small-text-subtle;
      }
      &:focus-visible {
        background: bk.$theme-dropdown-menu-menu-background-focused;
        
        // stylelint-disable-next-line declaration-no-important -- Override accessibility layer
        outline: var(--bk-focus-outline-width) solid var(--bk-focus-outline-color) !important;
        // stylelint-disable-next-line declaration-no-important -- Override accessibility layer
        outline-offset: calc(-1 * var(--bk-focus-outline-width)) !important;
      }
      
      &.bk-list-box__item--option {
        // Options get indented a little bit more
        padding-inline-start: calc(var(--bk-list-box-item-padding-inline) + bk.$spacing-2);
      }
      
      &.bk-list-box__item--header {
        position: sticky;
        inset-block-start: 0;
        user-select: none;
        
        color: bk.$theme-text-small-text-subtle;
        font-size: bk.$font-size-s;
        text-transform: uppercase;
        
        /* In the future, we could use a scroll state query to add a shadow while stuck
        @container scroll-state(stuck: top) {
          box-shadow: ...
        }
        */
      }
      
      &.bk-list-box__item--action {
        user-select: none;
        
        // Actions (non-sticky) get indented a little bit more
        &:not(.bk-list-box__item--sticky-end) {
          padding-inline-start: calc(var(--bk-list-box-item-padding-inline) + bk.$spacing-2);
        }
        
        &.bk-list-box__item--sticky-end {
          position: sticky;
          inset-block-end: 0;
          
          font-weight: bk.$font-weight-semibold;
          font-size: bk.$font-size-s;
          text-transform: uppercase;
        }
      }
      
      @include bk.focus-hidden; // Make sure the default `Button` focus styling is not applied (e.g. through shift key)
    }
    
    @include bk.focus-hidden;
  }
}
